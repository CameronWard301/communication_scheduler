# Automation Pipelines

<!-- TOC -->
* [Automation Pipelines](#automation-pipelines)
  * [Prerequisites](#prerequisites)
  * [Build And Unit Test Pipelines](#build-and-unit-test-pipelines)
    * [Images Pushed:](#images-pushed)
    * [Configuration:](#configuration)
    * [Prerequisites:](#prerequisites-1)
  * [CodeQL Analysis Pipeline](#codeql-analysis-pipeline)
  * [Terraform Deployment Pipeline](#terraform-deployment-pipeline)
    * [Configuration:](#configuration-1)
    * [Prerequisites:](#prerequisites-2)
  * [Helm/Kubernetes Deployment Pipeline](#helmkubernetes-deployment-pipeline)
    * [Configuration:](#configuration-2)
    * [Prerequisites:](#prerequisites-3)
<!-- TOC -->

This page describes the pipelines available in this repository and how to use them.

## Prerequisites
1. Fork this repository
2. Have access to [GitHub Actions](https://github.com/features/actions)


## Build And Unit Test Pipelines
- The build and unit test pipelines are triggered on every push to the repository that makes changes to the microservice folders.
  - E.g. changing the auth-api triggers the build-java-containers.yml pipeline.
- It builds each microservice, runs the unit tests and pushes to Dockerhub.
  - If unit tests fail the deployment pipeline stops.
- They read the version number from the pom.xml or package.json file and tag the image built with this version number.

### Images Pushed:
- [SMS Gateway](https://hub.docker.com/r/cameronward/sms-gateway). See the [project](../../sms-gateway)
- [Email Gateway](https://hub.docker.com/r/cameronward/email-gateway). See the [project](../../email-gateway)
- [Communication Worker](https://hub.docker.com/r/cameronward/communication-worker). See the [project](../../communication-worker)
- [cs-integration-tests](https://hub.docker.com/r/cameronward/cs-integration-tests). See the [project](../../integration-tests)
- [Schedule API](https://hub.docker.com/r/cameronward/schedule-api). See the [project](../../schedule-api)
- [Gateway API](https://hub.docker.com/r/cameronward/gateway-api). See the [project](../../gateway-api)
- [Data Converter API](https://hub.docker.com/r/cameronward/gateway-api). See the [project](../../data-converter-api)
- [Auth API](https://hub.docker.com/r/cameronward/gateway-api). See the [project](../../auth-api)
- [Preferences API](https://hub.docker.com/r/cameronward/preferences-api). See the [project](../../preferences-api)
- [Web Portal](https://hub.docker.com/r/cameronward/cs-web-portal). See the [project](../../web-portal)
- [Web Portal BFF](https://hub.docker.com/r/cameronward/cs-web-portal-bff). See the [project](../../web-portal-bff)
- [Mock Gateway](https://hub.docker.com/r/cameronward/mock-gateway). See the [project](../../mock-gateway)
- [History API](https://hub.docker.com/r/cameronward/history-api). See the [project](../../history-api)
 
### Configuration:
- To add secrets to a repository see here: [GitHub Secrets](https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository) 
- Make sure the following secrets are set in the repository settings:

| Secret name        | Description                                                                                                                                   |
|--------------------|-----------------------------------------------------------------------------------------------------------------------------------------------|
| DOCKERHUB_USERNAME | The Dockerhub username to push images to                                                                                                      |
| DOCKERHUB_TOKEN    | Your Dockerhub token to authenticate with. [See this guide](https://docs.docker.com/security/for-developers/access-tokens/) to get your token |

### Prerequisites:
1. [Dockerhub](https://hub.docker.com/) account to push images to
2. Add the secrets to the repository settings using the configuration section above

## CodeQL Analysis Pipeline
- The CodeQL analysis pipeline is triggered on every push to the repository.
- The pipeline in this project was generated by GitHub.
- To learn more about code QL see here: [CodeQL](https://docs.github.com/en/code-security/code-scanning/automating-code-scanning-with-github-actions/about-code-scanning)

## Terraform Deployment Pipeline
This pipeline is responsible for deploying the infrastructure to AWS and MongoDB using Terraform and Terragrunt.
- The pipeline produces a terraform plan for every push to the repository.
- The pipeline applies the plan when anything is commited or merged to the main branch.

### Configuration:
- To add secrets to a repository see here: [GitHub Secrets](https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository)
- Make sure the following secrets are set in the repository settings:

| Secret Name           | Description                                                                                                                                                                                                                |
|-----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| AWS_ACCESS_KEY_ID     | Create an AWS Access and Secret Key user using [this guide](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html) It should have administrator permissions to create and destroy AWS resources |
| AWS_SECRET_ACCESS_KEY | ^^                                                                                                                                                                                                                         |
| TEMPORAL_DB_USERNAME  | The Temporal RDS database username created in the [Terragrunt project](../../deployment/terragrunt/README.md#temporal-database-credentials)                                                                                |
| TEMPORAL_DB_PASSWORD  | The Temporal RDS database password created in the [Terragrunt project](../../deployment/terragrunt/README.md#temporal-database-credentials)                                                                                |
| MONGO_PRIVATE_KEY     | The MongoDB private key generated from the [Terragrunt project - MongoDB Atlas authentication](../../deployment/terragrunt/README.md#mongodb-atlas-authentication) section                                                 |
| MONGO_PUBLIC_KEY      | The MongoDB public key generated from the [Terragrunt project - MongoDB Atlas authentication](../../deployment/terragrunt/README.md#mongodb-atlas-authentication) section                                                  |

### Prerequisites:
1. Deploy the infrastructure using the provided [Terragrunt project](../../deployment/terragrunt) first manually
2. Use the configuration section above to set the required secrets in the repository settings


## Helm/Kubernetes Deployment Pipeline
This pipeline is responsible for deploying the services to the EKS cluster using Helm.
- The pipeline runs every time a push is made to the helm folder.
  - A plan is produced
- When any push or merge is made to the main branch the plan is applied.

### Configuration:
- To add secrets to a repository see here: [GitHub Secrets](https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository)
- Make sure the following secrets are set in the repository settings:

| Secret Name           | Description                                                                                                                                                                                                                |
|-----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| AWS_ACCESS_KEY_ID     | Create an AWS Access and Secret Key user using [this guide](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html) It should have administrator permissions to create and destroy AWS resources |
| AWS_SECRET_ACCESS_KEY | ^^                                                                                                                                                                                                                         |
| TEMPORAL_DB_USERNAME  | The Temporal RDS database username created in the [Terragrunt project](../../deployment/terragrunt/README.md#temporal-database-credentials)                                                                                |
| TEMPORAL_DB_PASSWORD  | The Temporal RDS database password created in the [Terragrunt project](../../deployment/terragrunt/README.md#temporal-database-credentials)                                                                                |

**Additionally, each secret in the values-example-secrets.yaml** Should be added as a secret in the repository settings.
* See the [Helm Deployment](../../deployment/helm) for more information on the secrets required.
* Each resource will contain more information about the configuration parameter in its readme.

### Prerequisites:
1. Deploy the infrastructure using the provided [Terragrunt project](../../deployment/terragrunt) first manually
2. Deploy the kube resources using the provided [Helm chart](../../deployment/helm) first manually
3. Use the configuration section above to set the required secrets in the repository settings
4. Add the user created from the configuration above to the cluster users map:
   1. Run `kubectl edit configmap aws-auth --namespace kube-system` and add the following to the mapUsers section:
    ```kubernetes helm
    apiVersion: v1
    data:
      mapRoles: |
        # might have other roles here
      mapUsers: |
        - userarn: <user arn> # arn of the user created in the configuration above
          username: <username> # username of the user created when setting up the user
          groups:
            - system:masters
    ```
